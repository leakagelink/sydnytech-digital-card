name: Build Android APK

on:
  repository_dispatch:
    types: [build-android-apk]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name'
        required: true
        type: string
      package_name:
        description: 'Package name (e.g., com.example.app)'
        required: true
        type: string
      build_id:
        description: 'Build ID for tracking'
        required: true
        type: string

env:
  APP_NAME: ${{ github.event.inputs.app_name || github.event.client_payload.app_name }}
  PACKAGE_NAME: ${{ github.event.inputs.package_name || github.event.client_payload.package_name }}
  BUILD_ID: ${{ github.event.inputs.build_id || github.event.client_payload.build_id }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Show inputs
        run: |
          echo "App Name: ${{ env.APP_NAME }}"
          echo "Package Name: ${{ env.PACKAGE_NAME }}"
          echo "Build ID: ${{ env.BUILD_ID }}"
          echo "Event: ${{ github.event_name }}"

      - name: Detect project type
        id: detect
        run: |
          echo "=== Project Structure ===" 
          ls -la
          if [ -f "gradlew" ] && ([ -f "app/build.gradle" ] || [ -f "app/build.gradle.kts" ]); then
            echo "project_type=native" >> $GITHUB_OUTPUT
            echo "✅ Detected Native Android project"
          elif [ -f "package.json" ]; then
            echo "project_type=web" >> $GITHUB_OUTPUT
            echo "✅ Detected Web/React project - will convert to APK"
            cat package.json | head -20
          else
            echo "project_type=unknown" >> $GITHUB_OUTPUT
            echo "❌ Unknown project type - will try web build anyway"
          fi

      # ========== JDK & ANDROID SDK SETUP (FOR ALL PROJECT TYPES) ==========
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ========== WEB PROJECT BUILD PATH ==========
      - name: Setup Node.js
        if: steps.detect.outputs.project_type == 'web' || steps.detect.outputs.project_type == 'unknown'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.detect.outputs.project_type == 'web' || steps.detect.outputs.project_type == 'unknown'
        run: |
          echo "=== Installing dependencies ==="
          if [ -f "package-lock.json" ]; then
            npm ci --legacy-peer-deps || npm install --legacy-peer-deps
          elif [ -f "yarn.lock" ]; then
            npm install -g yarn && yarn install
          elif [ -f "bun.lockb" ]; then
            npm install -g bun && bun install
          else
            npm install --legacy-peer-deps
          fi

      - name: Build web app
        if: steps.detect.outputs.project_type == 'web' || steps.detect.outputs.project_type == 'unknown'
        run: |
          echo "=== Building web app ==="
          npm run build || echo "Build command failed, checking for pre-built files..."
          echo "=== Build output ==="
          ls -la dist/ 2>/dev/null || ls -la build/ 2>/dev/null || ls -la out/ 2>/dev/null || echo "No standard build folder found"
        env:
          CI: false
          NODE_ENV: production

      - name: Determine build folder
        if: steps.detect.outputs.project_type == 'web' || steps.detect.outputs.project_type == 'unknown'
        id: build-folder
        run: |
          if [ -d "dist" ] && [ -f "dist/index.html" ]; then
            echo "folder=dist" >> $GITHUB_OUTPUT
            echo "✅ Using dist folder"
          elif [ -d "build" ] && [ -f "build/index.html" ]; then
            echo "folder=build" >> $GITHUB_OUTPUT
            echo "✅ Using build folder"
          elif [ -d "out" ] && [ -f "out/index.html" ]; then
            echo "folder=out" >> $GITHUB_OUTPUT
            echo "✅ Using out folder"
          elif [ -d ".next" ]; then
            mkdir -p dist
            cp -r .next/static dist/ 2>/dev/null || true
            cp -r public/* dist/ 2>/dev/null || true
            echo "folder=dist" >> $GITHUB_OUTPUT
            echo "✅ Using Next.js output"
          else
            echo "❌ No build output found, creating placeholder"
            mkdir -p dist
            echo "<!DOCTYPE html><html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>${{ env.APP_NAME }}</title></head><body><h1>Build Error</h1><p>Web build failed. Please check your project configuration.</p></body></html>" > dist/index.html
            echo "folder=dist" >> $GITHUB_OUTPUT
          fi

      - name: Convert Web to APK
        id: web-to-apk
        if: steps.detect.outputs.project_type == 'web' || steps.detect.outputs.project_type == 'unknown'
        uses: nicoulaj/nicoulaj-web-to-apk-action@master
        with:
          build-folder-path: ${{ steps.build-folder.outputs.folder }}
          app-name: ${{ env.APP_NAME }}
          output-folder-path: 'output-apk'
        continue-on-error: true

      - name: Manual APK Build (Fallback)
        if: (steps.detect.outputs.project_type == 'web' || steps.detect.outputs.project_type == 'unknown') && steps.web-to-apk.outcome == 'failure'
        run: |
          echo "=== Manual APK Build (Fallback) ==="
          
          # Create Android project structure
          mkdir -p apk-project/app/src/main/java/$(echo "${{ env.PACKAGE_NAME }}" | tr '.' '/')
          mkdir -p apk-project/app/src/main/res/values
          mkdir -p apk-project/app/src/main/res/drawable
          mkdir -p apk-project/app/src/main/assets/www
          
          # Copy web files
          cp -r ${{ steps.build-folder.outputs.folder }}/* apk-project/app/src/main/assets/www/
          
          # Create MainActivity.java
          PACKAGE_DIR=$(echo "${{ env.PACKAGE_NAME }}" | tr '.' '/')
          cat > apk-project/app/src/main/java/$PACKAGE_DIR/MainActivity.java << 'MAINEOF'
package PLACEHOLDER_PACKAGE;
import android.app.Activity;
import android.os.Bundle;
import android.webkit.WebView;
import android.webkit.WebSettings;
import android.webkit.WebViewClient;
public class MainActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        WebView webView = new WebView(this);
        setContentView(webView);
        WebSettings settings = webView.getSettings();
        settings.setJavaScriptEnabled(true);
        settings.setDomStorageEnabled(true);
        webView.setWebViewClient(new WebViewClient());
        webView.loadUrl("file:///android_asset/www/index.html");
    }
}
MAINEOF
          
          # Fix package name in MainActivity
          sed -i "s/PLACEHOLDER_PACKAGE/${{ env.PACKAGE_NAME }}/g" apk-project/app/src/main/java/$PACKAGE_DIR/MainActivity.java
          
          # Create AndroidManifest.xml
          cat > apk-project/app/src/main/AndroidManifest.xml << EOF
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="${{ env.PACKAGE_NAME }}">
    <uses-permission android:name="android.permission.INTERNET"/>
    <application android:label="${{ env.APP_NAME }}" android:usesCleartextTraffic="true">
        <activity android:name=".MainActivity" android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF
          
          # Create app/build.gradle
          cat > apk-project/app/build.gradle << EOF
plugins { id 'com.android.application' }
android {
    namespace '${{ env.PACKAGE_NAME }}'
    compileSdk 34
    defaultConfig {
        applicationId "${{ env.PACKAGE_NAME }}"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }
    buildTypes { debug { minifyEnabled false } }
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
}
EOF
          
          # Create settings.gradle
          cat > apk-project/settings.gradle << EOF
pluginManagement {
    repositories { google(); mavenCentral(); gradlePluginPortal() }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories { google(); mavenCentral() }
}
rootProject.name = "${{ env.APP_NAME }}"
include ':app'
EOF
          
          # Create root build.gradle
          cat > apk-project/build.gradle << EOF
plugins { id 'com.android.application' version '8.2.0' apply false }
EOF
          
          # Create gradle.properties
          cat > apk-project/gradle.properties << EOF
android.useAndroidX=true
org.gradle.jvmargs=-Xmx2048m
EOF
          
          # Create gradle wrapper
          cd apk-project
          mkdir -p gradle/wrapper
          cat > gradle/wrapper/gradle-wrapper.properties << EOF
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
          
          # Download and setup gradle wrapper
          curl -sL https://raw.githubusercontent.com/nicoulaj/nicoulaj-web-to-apk-action/master/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar ||             curl -sL https://services.gradle.org/distributions/gradle-8.5-bin.zip -o gradle.zip && unzip -q gradle.zip && ./gradle-8.5/bin/gradle wrapper
          
          cat > gradlew << 'GRADLEW'
#!/bin/sh
exec java -jar "$(dirname "$0")/gradle/wrapper/gradle-wrapper.jar" "$@"
GRADLEW
          chmod +x gradlew
          
          # Build APK
          ./gradlew assembleDebug --no-daemon --stacktrace || {
            echo "Gradle wrapper failed, using system gradle"
            gradle assembleDebug --no-daemon --stacktrace
          }
          
          mkdir -p ../output-apk
          find . -name "*.apk" -exec cp {} ../output-apk/ ;
          cd ..
          
          echo "=== APK Build Complete ==="
          ls -la output-apk/

      # ========== NATIVE ANDROID BUILD PATH ==========
      - name: Update app name (Native)
        if: steps.detect.outputs.project_type == 'native'
        run: |
          if [ -f "app/src/main/res/values/strings.xml" ]; then
            sed -i 's/<string name="app_name">.*</string>/<string name="app_name">${{ env.APP_NAME }}</string>/' app/src/main/res/values/strings.xml
          fi

      - name: Build APK (Native)
        if: steps.detect.outputs.project_type == 'native'
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug --no-daemon
          mkdir -p output-apk
          find . -name "*.apk" -path "*/debug/*" -exec cp {} output-apk/ ;

      # ========== UPLOAD ARTIFACT ==========
      - name: Find and Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-${{ env.BUILD_ID }}
          path: |
            output-apk/*.apk
            **/app/build/outputs/apk/debug/*.apk
          retention-days: 1
          if-no-files-found: error
