name: Build Android APK

on:
  repository_dispatch:
    types: [build-android-apk]
  workflow_dispatch:
    inputs:
      app_name:
        description: Application name
        required: true
        type: string
      package_name:
        description: Package name
        required: true
        type: string
      build_id:
        description: Build ID
        required: true
        type: string

env:
  APP_NAME: ${{ github.event.inputs.app_name || github.event.client_payload.app_name || 'MyApp' }}
  PACKAGE_NAME: ${{ github.event.inputs.package_name || github.event.client_payload.package_name || 'com.example.app' }}
  BUILD_ID: ${{ github.event.inputs.build_id || github.event.client_payload.build_id || 'manual' }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug inputs
        run: echo "Building ${{ env.APP_NAME }} with package ${{ env.PACKAGE_NAME }}"

      - name: Detect project type
        id: detect
        run: |
          if [ -f "gradlew" ] && [ -d "app" ]; then
            echo "type=native" >> $GITHUB_OUTPUT
          else
            echo "type=web" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Node.js
        if: steps.detect.outputs.type == 'web'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install and build web
        if: steps.detect.outputs.type == 'web'
        run: |
          npm install --legacy-peer-deps || true
          npm run build || true
        env:
          CI: false

      - name: Create Android project
        if: steps.detect.outputs.type == 'web'
        run: |
          SRCDIR="dist"
          [ -d "build" ] && SRCDIR="build"
          [ -d "public" ] && [ ! -d "dist" ] && [ ! -d "build" ] && SRCDIR="public"
          mkdir -p dist && echo "<html><body><h1>App</h1></body></html>" > dist/index.html || true
          
          PKG_PATH=$(echo "${{ env.PACKAGE_NAME }}" | tr '.' '/')
          mkdir -p app/src/main/java/$PKG_PATH app/src/main/assets/www app/src/main/res/values
          cp -r $SRCDIR/* app/src/main/assets/www/ 2>/dev/null || cp -r dist/* app/src/main/assets/www/
          
          cat > app/src/main/java/$PKG_PATH/MainActivity.java << 'JAVAEOF'
          package PKGPLACEHOLDER;
          import android.app.Activity;
          import android.os.Bundle;
          import android.webkit.WebView;
          import android.webkit.WebSettings;
          import android.webkit.WebViewClient;
          public class MainActivity extends Activity {
            protected void onCreate(Bundle s) {
              super.onCreate(s);
              WebView w = new WebView(this);
              setContentView(w);
              w.getSettings().setJavaScriptEnabled(true);
              w.getSettings().setDomStorageEnabled(true);
              w.setWebViewClient(new WebViewClient());
              w.loadUrl("file:///android_asset/www/index.html");
            }
          }
          JAVAEOF
          sed -i "s/PKGPLACEHOLDER/${{ env.PACKAGE_NAME }}/g" app/src/main/java/$PKG_PATH/MainActivity.java
          
          cat > app/src/main/AndroidManifest.xml << 'MANIFESTEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="PKGPLACEHOLDER">
            <uses-permission android:name="android.permission.INTERNET"/>
            <application android:label="APPPLACEHOLDER" android:usesCleartextTraffic="true">
              <activity android:name=".MainActivity" android:exported="true">
                <intent-filter>
                  <action android:name="android.intent.action.MAIN"/>
                  <category android:name="android.intent.category.LAUNCHER"/>
                </intent-filter>
              </activity>
            </application>
          </manifest>
          MANIFESTEOF
          sed -i "s/PKGPLACEHOLDER/${{ env.PACKAGE_NAME }}/g" app/src/main/AndroidManifest.xml
          sed -i "s/APPPLACEHOLDER/${{ env.APP_NAME }}/g" app/src/main/AndroidManifest.xml
          
          cat > app/build.gradle << 'GRADLEEOF'
          plugins { id 'com.android.application' }
          android {
            namespace 'PKGPLACEHOLDER'
            compileSdk 34
            defaultConfig {
              applicationId "PKGPLACEHOLDER"
              minSdk 21
              targetSdk 34
              versionCode 1
              versionName "1.0"
            }
            buildTypes { debug { minifyEnabled false } }
            compileOptions {
              sourceCompatibility JavaVersion.VERSION_17
              targetCompatibility JavaVersion.VERSION_17
            }
          }
          GRADLEEOF
          sed -i "s/PKGPLACEHOLDER/${{ env.PACKAGE_NAME }}/g" app/build.gradle
          
          cat > settings.gradle << 'SETTINGSEOF'
          pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }
          dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS); repositories { google(); mavenCentral() } }
          rootProject.name = 'MyApp'
          include ':app'
          SETTINGSEOF
          
          echo "plugins { id 'com.android.application' version '8.2.0' apply false }" > build.gradle
          echo -e "android.useAndroidX=true\norg.gradle.jvmargs=-Xmx4096m" > gradle.properties

      - name: Setup Gradle
        if: steps.detect.outputs.type == 'web'
        run: |
          curl -sL "https://services.gradle.org/distributions/gradle-8.5-bin.zip" -o gradle.zip
          unzip -q gradle.zip
          ./gradle-8.5/bin/gradle wrapper --gradle-version 8.5
          chmod +x gradlew

      - name: Build APK
        run: |
          chmod +x ./gradlew 2>/dev/null || true
          ./gradlew assembleDebug --no-daemon
          mkdir -p output-apk
          find . -name "*.apk" -exec cp {} output-apk/ \;

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-${{ env.BUILD_ID }}
          path: output-apk/*.apk
          retention-days: 1
          if-no-files-found: error
