name: Build Android APK

on:
  repository_dispatch:
    types: [build-android-apk]
  workflow_dispatch:
    inputs:
      app_name:
        description: Application name
        required: true
        type: string
      package_name:
        description: Package name
        required: true
        type: string
      build_id:
        description: Build ID
        required: true
        type: string

env:
  APP_NAME: ${{ github.event.inputs.app_name || github.event.client_payload.app_name || 'MyApp' }}
  PACKAGE_NAME: ${{ github.event.inputs.package_name || github.event.client_payload.package_name || 'com.example.app' }}
  BUILD_ID: ${{ github.event.inputs.build_id || github.event.client_payload.build_id || 'manual' }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        run: |
          if [ -f "gradlew" ] && [ -d "app" ]; then
            echo "type=native" >> $GITHUB_OUTPUT
          else
            echo "type=web" >> $GITHUB_OUTPUT
          fi
          echo "Project type detected"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Node.js
        if: steps.detect.outputs.type == 'web'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure Vite for mobile
        if: steps.detect.outputs.type == 'web'
        run: |
          if [ -f "vite.config.ts" ] || [ -f "vite.config.js" ]; then
            echo "Configuring Vite for mobile build..."
            if [ -f "vite.config.ts" ]; then
              sed -i "s/base: *'[^']*'/base: '.\/'/g" vite.config.ts || true
              if ! grep -q "base:" vite.config.ts; then
                sed -i "s/defineConfig({/defineConfig({ base: '.\/'',/g" vite.config.ts || true
              fi
            fi
            if [ -f "vite.config.js" ]; then
              sed -i "s/base: *'[^']*'/base: '.\/'/g" vite.config.js || true
            fi
          fi

      - name: Install dependencies
        if: steps.detect.outputs.type == 'web'
        run: |
          if [ -f "bun.lockb" ]; then
            npm install -g bun && bun install
          elif [ -f "yarn.lock" ]; then
            npm install -g yarn && yarn install --frozen-lockfile || yarn install
          elif [ -f "pnpm-lock.yaml" ]; then
            npm install -g pnpm && pnpm install --frozen-lockfile || pnpm install
          else
            npm ci || npm install --legacy-peer-deps || npm install --force
          fi

      - name: Build web app
        if: steps.detect.outputs.type == 'web'
        run: |
          export VITE_BASE="./"
          npm run build || yarn build || pnpm build || bun run build
        env:
          CI: false
          NODE_ENV: production
          PUBLIC_URL: "./"
          BASE_URL: "./"

      - name: Fix asset paths
        if: steps.detect.outputs.type == 'web'
        run: |
          SRCDIR=""
          for dir in dist build .next/out out public; do
            if [ -d "$dir" ] && [ -f "$dir/index.html" ]; then
              SRCDIR="$dir"
              break
            fi
          done
          
          if [ -z "$SRCDIR" ]; then
            for dir in dist build; do
              if [ -d "$dir" ]; then
                SRCDIR="$dir"
                break
              fi
            done
          fi
          
          if [ -z "$SRCDIR" ]; then
            echo "ERROR: No build output found"
            exit 1
          fi
          
          echo "BUILD_DIR=$SRCDIR" >> $GITHUB_ENV
          echo "Found build in: $SRCDIR"
          
          if [ -f "$SRCDIR/index.html" ]; then
            echo "Fixing absolute paths in index.html..."
            sed -i 's|="/|="./|g' "$SRCDIR/index.html"
            sed -i 's|href="/|href="./|g' "$SRCDIR/index.html"
            sed -i 's|src="/|src="./|g' "$SRCDIR/index.html"
            sed -i 's|url(/|url(./|g' "$SRCDIR/index.html"
            echo "=== index.html content ==="
            head -30 "$SRCDIR/index.html"
          fi
          
          echo "=== Build contents ==="
          ls -la "$SRCDIR/"

      - name: Create Android project
        if: steps.detect.outputs.type == 'web'
        run: |
          PKG="${{ env.PACKAGE_NAME }}"
          PKG_PATH=$(echo "$PKG" | tr '.' '/')
          SRCDIR="${{ env.BUILD_DIR }}"
          
          mkdir -p app/src/main/java/$PKG_PATH
          mkdir -p app/src/main/assets/www
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          
          echo "Copying web assets from $SRCDIR..."
          cp -r "$SRCDIR"/* app/src/main/assets/www/
          
          ICON_SRC=""
          for icon in "$SRCDIR/favicon.png" "$SRCDIR/favicon.ico" "$SRCDIR/logo.png" "$SRCDIR/icon.png" "public/favicon.png" "public/favicon.ico" "public/logo.png"; do
            if [ -f "$icon" ]; then
              ICON_SRC="$icon"
              break
            fi
          done
          
          if [ -n "$ICON_SRC" ]; then
            echo "Using icon: $ICON_SRC"
            cp "$ICON_SRC" app/src/main/res/mipmap-hdpi/ic_launcher.png 2>/dev/null || true
            cp "$ICON_SRC" app/src/main/res/mipmap-xhdpi/ic_launcher.png 2>/dev/null || true
          else
            echo "Creating default icon..."
            echo '<?xml version="1.0" encoding="utf-8"?><shape xmlns:android="http://schemas.android.com/apk/res/android" android:shape="oval"><solid android:color="#6366F1"/></shape>' > app/src/main/res/drawable/ic_launcher.xml
          fi
          
          cat > app/src/main/res/values/colors.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources><color name="colorPrimary">#6366F1</color></resources>
          EOF
          
          cat > app/src/main/java/$PKG_PATH/MainActivity.java << JAVAEOF
          package $PKG;
          import android.app.Activity;
          import android.os.Bundle;
          import android.webkit.*;
          import android.view.*;
          import android.net.Uri;
          import android.content.Intent;
          public class MainActivity extends Activity {
            private WebView webView;
            @Override protected void onCreate(Bundle savedInstanceState) {
              super.onCreate(savedInstanceState);
              requestWindowFeature(Window.FEATURE_NO_TITLE);
              getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN);
              webView = new WebView(this);
              setContentView(webView);
              WebSettings s = webView.getSettings();
              s.setJavaScriptEnabled(true);
              s.setDomStorageEnabled(true);
              s.setAllowFileAccess(true);
              s.setAllowContentAccess(true);
              s.setAllowFileAccessFromFileURLs(true);
              s.setAllowUniversalAccessFromFileURLs(true);
              s.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);
              s.setCacheMode(WebSettings.LOAD_NO_CACHE);
              s.setDatabaseEnabled(true);
              s.setMediaPlaybackRequiresUserGesture(false);
              s.setUseWideViewPort(true);
              s.setLoadWithOverviewMode(true);
              webView.setWebViewClient(new WebViewClient() {
                @Override public boolean shouldOverrideUrlLoading(WebView v, WebResourceRequest r) {
                  String url = r.getUrl().toString();
                  if (url.startsWith("http://") || url.startsWith("https://")) {
                    if (!url.contains("localhost") && !url.contains("127.0.0.1")) {
                      startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(url)));
                      return true;
                    }
                  }
                  return false;
                }
              });
              webView.setWebChromeClient(new WebChromeClient());
              webView.loadUrl("file:///android_asset/www/index.html");
            }
            @Override public void onBackPressed() {
              if (webView != null && webView.canGoBack()) { webView.goBack(); } else { super.onBackPressed(); }
            }
          }
          JAVAEOF
          
          cat > app/src/main/AndroidManifest.xml << MANIFESTEOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="$PKG">
            <uses-permission android:name="android.permission.INTERNET"/>
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
            <application 
              android:label="${{ env.APP_NAME }}" 
              android:icon="@mipmap/ic_launcher"
              android:usesCleartextTraffic="true"
              android:hardwareAccelerated="true"
              android:requestLegacyExternalStorage="true">
              <activity android:name=".MainActivity" android:exported="true" android:configChanges="orientation|screenSize|keyboard|keyboardHidden" android:windowSoftInputMode="adjustResize">
                <intent-filter>
                  <action android:name="android.intent.action.MAIN"/>
                  <category android:name="android.intent.category.LAUNCHER"/>
                </intent-filter>
              </activity>
            </application>
          </manifest>
          MANIFESTEOF
          
          if [ ! -f "app/src/main/res/mipmap-hdpi/ic_launcher.png" ]; then
            sed -i 's|android:icon="@mipmap/ic_launcher"|android:icon="@drawable/ic_launcher"|g' app/src/main/AndroidManifest.xml
          fi
          
          cat > app/build.gradle << GRADLEEOF
          plugins { id 'com.android.application' }
          android {
            namespace '$PKG'
            compileSdk 34
            defaultConfig {
              applicationId "$PKG"
              minSdk 21
              targetSdk 34
              versionCode 1
              versionName "1.0"
            }
            buildTypes { 
              debug { minifyEnabled false; debuggable true } 
              release { minifyEnabled false }
            }
            compileOptions {
              sourceCompatibility JavaVersion.VERSION_17
              targetCompatibility JavaVersion.VERSION_17
            }
          }
          GRADLEEOF
          
          cat > settings.gradle << 'SETTINGSEOF'
          pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }
          dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS); repositories { google(); mavenCentral() } }
          include ':app'
          SETTINGSEOF
          
          echo "plugins { id 'com.android.application' version '8.2.0' apply false }" > build.gradle
          printf "android.useAndroidX=true\norg.gradle.jvmargs=-Xmx4096m\norg.gradle.parallel=true" > gradle.properties
          
          echo "=== Copied web assets ==="
          ls -la app/src/main/assets/www/ | head -10
          echo "=== Checking index.html ==="
          head -20 app/src/main/assets/www/index.html || echo "No index.html found!"

      - name: Setup Gradle
        if: steps.detect.outputs.type == 'web'
        run: |
          curl -sL "https://services.gradle.org/distributions/gradle-8.5-bin.zip" -o gradle.zip
          unzip -q gradle.zip
          ./gradle-8.5/bin/gradle wrapper --gradle-version 8.5
          chmod +x gradlew

      - name: Build APK
        run: |
          chmod +x ./gradlew 2>/dev/null || true
          ./gradlew assembleDebug --no-daemon --info
          mkdir -p output-apk
          find . -name "*.apk" -exec cp {} output-apk/ \;
          echo "=== Built APKs ==="
          ls -la output-apk/

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-${{ env.BUILD_ID }}
          path: output-apk/*.apk
          retention-days: 1
          if-no-files-found: error
