name: Build Android APK
on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name'
        required: true
        type: string
      package_name:
        description: 'Package name (e.g., com.example.app)'
        required: true
        type: string
      build_id:
        description: 'Build ID for tracking'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Validate Android project
        id: validate
        run: |
          if [ ! -f "gradlew" ]; then
            echo "ERROR: gradlew not found. This does not appear to be a valid Android project."
            exit 1
          fi
          if [ ! -f "app/build.gradle" ] && [ ! -f "app/build.gradle.kts" ]; then
            echo "ERROR: app/build.gradle not found. Invalid Android project structure."
            exit 1
          fi
          echo "Android project validation passed"

      - name: Update app name
        run: |
          if [ -f "app/src/main/res/values/strings.xml" ]; then
            sed -i 's/<string name="app_name">.*<\/string>/<string name="app_name">${{ inputs.app_name }}<\/string>/' app/src/main/res/values/strings.xml
          fi

      - name: Update package name
        run: |
          OLD_PACKAGE=$(grep -oP 'namespace\s*=?\s*["'"'"']\K[^"'"'"']+' app/build.gradle* 2>/dev/null | head -1 || grep -oP 'applicationId\s*["'"'"']\K[^"'"'"']+' app/build.gradle* 2>/dev/null | head -1)
          if [ -n "$OLD_PACKAGE" ]; then
            echo "Changing package from $OLD_PACKAGE to ${{ inputs.package_name }}"
            find . -name "*.gradle*" -exec sed -i "s/$OLD_PACKAGE/${{ inputs.package_name }}/g" {} \;
            find . -name "AndroidManifest.xml" -exec sed -i "s/$OLD_PACKAGE/${{ inputs.package_name }}/g" {} \;
          fi

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: Find APK
        id: find-apk
        run: |
          APK_PATH=$(find . -name "*.apk" -path "*/debug/*" | head -1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK at: $APK_PATH"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-${{ inputs.build_id }}
          path: ${{ steps.find-apk.outputs.apk_path }}
          retention-days: 1
